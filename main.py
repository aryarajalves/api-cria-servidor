import os
import json
import requests
from fastapi import FastAPI, HTTPException, status
from pydantic import BaseModel, Field
from dotenv import load_dotenv
from typing import Dict, Any

# Carrega as vari√°veis do arquivo .env para o ambiente de execu√ß√£o.
load_dotenv()

# --- Configura√ß√£o ---
N8N_URL = os.getenv("N8N_URL")
N8N_API_KEY = os.getenv("N8N_API_KEY")

if not N8N_URL or not N8N_API_KEY:
    raise ValueError(
        "As vari√°veis de ambiente N8N_URL e N8N_API_KEY devem ser definidas no arquivo .env"
    )

# --- Modelo de Dados de Entrada (Request Body) ---
# ATUALIZA√á√ÉO: Modelo de dados expandido para incluir IDs de credenciais e sub-workflows.
class CredentialIDs(BaseModel):
    rabbitmq: str = Field(..., example="kkY4IfJwIiP6jvyg")
    baserowApi: str = Field(..., example="b2vp8bGMnmZj73Ul")
    postgres: str = Field(..., example="sVgZFNWirlEjgS9b")
    openAiApi: str = Field(..., example="DoWArxhqdimeNYvh")
    httpHeaderAuth: str = Field(..., example="eQ1HsqAxqfNn1xHg")

class SubWorkflowIDs(BaseModel):
    reserva_cliente: str = Field(..., example="npJU13j6rGaKDBpG")
    encerrou_conversa: str = Field(..., example="PQ9hq7nLXfDOjtlQ")
    verifica_vaga: str = Field(..., example="WdyPFNJeubZucz1M")
    cancelar_reserva: str = Field(..., example="K7N49LNANntlLKrt")
    retorna_datas_disponiveis: str = Field(..., example="LvhrtIcEd0OSsa4E")

class WorkflowRequest(BaseModel):
    workflow_name: str = Field(
        ..., 
        description="O nome que ser√° dado ao novo workflow no n8n.",
        example="Assistente IA Karuby"
    )
    credentials: CredentialIDs
    sub_workflows: SubWorkflowIDs

# --- Inst√¢ncia do FastAPI ---
app = FastAPI(
    title="n8n Workflow Creator API",
    description="Uma API para criar workflows complexos com credenciais e sub-workflows din√¢micos.",
    version="2.0.0" # Vers√£o atualizada com template complexo
)

# --- O Template do Workflow ---
# ATUALIZA√á√ÉO: Template substitu√≠do pelo novo workflow complexo.
# IDs de credenciais e workflows foram substitu√≠dos por placeholders.
WORKFLOW_TEMPLATE: Dict[str, Any] = {
  "name": "{{NOME_DO_WORKFLOW}}",
  "nodes": [
    {
      "parameters": {
        "queue": "assistenteIA",
        "options": {
          "acknowledge": "executionFinishesSuccessfully", "durable": True, "jsonParseBody": True, "parallelMessages": 10
        }
      },
      "id": "315e4a65-8096-4691-ace3-f8bdd3183879", "name": "RabbitMQ Trigger", "type": "n8n-nodes-base.rabbitmqTrigger", "typeVersion": 1, "position": [-3584, 464],
      "credentials": { "rabbitmq": { "id": "{{CRED_RABBITMQ}}", "name": "RabbitMQ account" } }
    },
    {
      "parameters": {
        "databaseId": 132, "tableId": 609, "limit": 1,
        "additionalOptions": { "filters": { "fields": [{ "field": 5865, "operator": "contains", "value": "={{ $('RabbitMQ Trigger').item.json.content.numero.replaceAll(\"+\",\"\").slice(-8) }}" }] } }
      },
      "id": "6b988949-5e24-4a2b-9953-04a6bbe62d36", "name": "Retorna Info Lead 01", "type": "n8n-nodes-base.baserow", "typeVersion": 1, "position": [-3360, 464],
      "credentials": { "baserowApi": { "id": "{{CRED_BASEROW}}", "name": "Baserow account" } }
    },
    {
      "parameters": {}, "type": "@n8n/n8n-nodes-langchain.toolCalculator", "typeVersion": 1, "position": [-1968, 816], "id": "ed57c87c-f12f-4fae-be59-4fdb95c03f67", "name": "Calculator 01"
    },
    {
      "parameters": { "jsCode": "// Obt√©m a data atual\nconst hoje = new Date();\n\n// Cria um array com os nomes dos dias da semana em portugu√™s\nconst diasDaSemana = [\n  'domingo',\n  'segunda-feira',\n  'ter√ßa-feira',\n  'quarta-feira',\n  'quinta-feira',\n  'sexta-feira',\n  's√°bado'\n];\n\n// Obt√©m o dia da semana (0-6) e usa para acessar o array\nconst diaDaSemanaHoje = diasDaSemana[hoje.getDay()];\n\n// Retorna o dia da semana\nreturn [{ json: { dia: diaDaSemanaHoje } }];\n" },
      "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [-2464, 592], "id": "12ba930b-04bc-4706-a024-6d825efab1c5", "name": "Code - Nome Dia Da Semana"
    },
    {
      "parameters": { "databaseId": 132, "tableId": 613, "returnAll": True, "additionalOptions": {} },
      "type": "n8n-nodes-base.baserow", "typeVersion": 1, "position": [-2688, 592], "id": "90f95558-22b5-4787-8d54-d2352ec46520", "name": "Retorna Variaveis Globais 01",
      "credentials": { "baserowApi": { "id": "{{CRED_BASEROW}}", "name": "Baserow account" } }
    },
    {
      "parameters": { "sessionIdType": "customKey", "sessionKey": "={{ $('Merge 01').item.json.id_memoria }}", "contextWindowLength": 20 },
      "id": "b598b378-c47a-4ac0-a2f1-64ff91070771", "name": "Postgres Chat Memory 01", "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat", "typeVersion": 1.1, "position": [-2096, 816],
      "credentials": { "postgres": { "id": "{{CRED_POSTGRES}}", "name": "Postgres account" } }
    },
    {
      "parameters": { "model": "gpt-4.1", "options": { "maxTokens": 2200, "temperature": 0.2, "maxRetries": 2, "topP": 1 } },
      "id": "81225792-fa5a-49eb-a2fd-7f52bd9be84d", "name": "OpenAI Chat Model 01", "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi", "typeVersion": 1, "position": [-2256, 816],
      "credentials": { "openAiApi": { "id": "{{CRED_OPENAI}}", "name": "OpenAi account" } }
    },
    {
      "parameters": { "public": True, "options": {} }, "type": "@n8n/n8n-nodes-langchain.chatTrigger", "typeVersion": 1.1, "position": [-3568, 720], "id": "4d14c769-ac6b-4a37-8394-9af72e58ccda", "name": "When chat message received", "webhookId": "a6b18e54-a00c-4e23-8b1c-e074ff27e9af"
    },
    {
      "parameters": { "assignments": { "assignments": [ { "id": "62a2d94e-9d0b-48b4-8138-7f02e372f42b", "name": "mensagem", "value": "={{ $('When chat message received').item.json.chatInput }}", "type": "string" }, { "id": "88bf59dd-ba3e-4f4a-b357-b023db8ee02b", "name": "id_memoria", "value": "={{ $('When chat message received').item.json.sessionId }}", "type": "string" }, { "id": "d73bf292-9fbf-4a77-9114-c3d536c51974", "name": "numero", "value": "5803250543", "type": "string" }, { "id": "42c329cd-d7d2-4202-a838-e8580df62e07", "name": "ferramentaDeTeste", "value": True, "type": "boolean" } ] }, "options": {} },
      "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [-3136, 720], "id": "e5682851-7bd9-4306-aaaf-b1284f9e72c0", "name": "Edit Fields 01"
    },
    {
      "parameters": { "assignments": { "assignments": [ { "id": "62a2d94e-9d0b-48b4-8138-7f02e372f42b", "name": "mensagem", "value": "={{ $('RabbitMQ Trigger').item.json.content.mensagemConcatenada }}", "type": "string" }, { "id": "88bf59dd-ba3e-4f4a-b357-b023db8ee02b", "name": "id_memoria", "value": "={{ $('Retorna Info Lead 01').item.json.ID }}", "type": "string" }, { "id": "23917aa7-5eaf-4613-8c64-63ed22216d90", "name": "numero", "value": "={{ $('RabbitMQ Trigger').item.json.content.numero }}", "type": "string" }, { "id": "6adc1522-0ed2-4e99-9f01-3b290db1fd2b", "name": "ferramentaDeTeste", "value": "={{ $('Retorna Info Lead 01').item.json[\"Qual E A Plataforma\"].value == \"Telegram\" ? true : false }}", "type": "boolean" } ] }, "options": {} },
      "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [-3136, 464], "id": "9105b80e-6362-45d7-8343-ee6a8a2c46b6", "name": "Edit Fields  02"
    },
    { "parameters": {}, "type": "n8n-nodes-base.merge", "typeVersion": 3.2, "position": [-2912, 592], "id": "0d22b574-5ab3-45f1-a2d1-bae072dbf619", "name": "Merge 01" },
    {
      "parameters": { "databaseId": 132, "tableId": 609, "limit": 1, "additionalOptions": { "filters": { "fields": [{ "field": 5865, "value": "={{ $('RabbitMQ Trigger').item.json.content.numero }}" }] } } },
      "type": "n8n-nodes-base.baserow", "typeVersion": 1, "position": [-1104, 480], "id": "32c0200d-a1a4-4159-8aa5-3edb9ebb458e", "name": "Retorna Info Lead  02",
      "credentials": { "baserowApi": { "id": "{{CRED_BASEROW}}", "name": "Baserow account" } }
    },
    {
      "parameters": { "method": "POST", "url": "={{ $('Edit Fields Info Mensagem').item.json.baseUrl }}/api/v1/accounts/{{ $('Retorna Info Lead 01').item.json['Conta ID'] }}/conversations/{{ $('Retorna Info Lead 01').item.json['Conversation ID'] }}/messages", "authentication": "genericCredentialType", "genericAuthType": "httpHeaderAuth", "sendBody": True, "bodyParameters": { "parameters": [ { "name": "message_type", "value": "=outgoing" }, { "name": "content", "value": "={{ $('AI Agent - Principal').item.json.output.trim().removeMarkdown() }}" }, { "name": "private", "value": "={{ false }}" } ] }, "options": {} },
      "id": "901d37dd-23b8-451b-8b91-93ccaa83c70c", "name": "Enviar Mensagem 01", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.2, "position": [-624, 480],
      "credentials": { "httpHeaderAuth": { "id": "{{CRED_HTTPHEADER}}", "name": "Header - Chatwoot" } }
    },
    {
      "parameters": { "assignments": { "assignments": [{ "id": "2c57b767-21d2-49a2-90ce-b50212526521", "name": "baseUrl", "value": "https://atendimentobase.aryaraj.shop", "type": "string" }] }, "options": {} },
      "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [-848, 480], "id": "db13fb56-52ba-4d09-96ef-e71d3addb64b", "name": "Edit Fields Info Mensagem"
    },
    { "parameters": {}, "type": "@n8n/n8n-nodes-langchain.toolThink", "typeVersion": 1, "position": [-1680, 960], "id": "af585148-c761-4102-a7c5-715ecd765736", "name": "Think" },
    {
      "parameters": { "name": "reservaCliente", "description": "Ferramenta respons√°vel por fazer a reserva no restaurante para o cliente, ou atualizar o n√∫mero de pessoas na reserva.", "workflowId": { "__rl": True, "value": "{{WF_RESERVA_CLIENTE}}", "mode": "id" }, "workflowInputs": { "mappingMode": "defineBelow", "value": { "whatsApp": "={{ $('Merge 01').item.json.numero }}", "quantidadePessoasReserva": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('quantidadePessoasReserva', `√â a quantidade de pessoas que v√£o vim para o restaurante por essa reserva, caso for o n√∫mero de pessoas atualizado quero que envie o n√∫mero cheio tamb√©m.\\n\\nPS. voc√™ precisa enviar esse valor como um n√∫mero inteiro, que √© a soma de todas as pessoas que v√£o para o rodizio.`, 'string') }}", "horarioReserva": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('horarioReserva', `Esse √© o hor√°rio que o usu√°rio escolheu para fazer a reserva dele no karubi.\\n\\nPS. Os unicos formatos que voc√™ deve enviar os hor√°rio s√£o: 19:00, ou 11:00.`, 'string') }}", "nomeReserva": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nomeReserva', `√â o nome da pessoa que fez a reserva.`, 'string') }}", "ativouVerificaVaga": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ativouVerificaVaga', `Retorne true caso voc√™ tamb√©m tenha chamado a ferramenta verificaVagaReserva, caso n√£o tenha chamado por padr√£o retorne false como resposta.`, 'string') }}", "precisaAtualizarPedido": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('precisaAtualizarPedido', `Quero que retorne \"true\" quando o usu√°rio quiser atualizar a sua reserva e caso n√£o queira retorne apenas \"false\".`, 'boolean') }}", "observacao": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('observacao', `Quando o usu√°rio enviar alguma informa√ß√£o adicional quero que envie nessa vari√°vel, como: quero uma mesa perto da janela, tem algum aniversariante indo para o karuby, queremos mesa longe da porta, cadeira infantil, ou perto do sof√°.`, 'string') }}", "etiquetas": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('etiquetas', ``, 'string') }}", "ferramentaDeTeste": "={{ $('Merge 01').item.json.ferramentaDeTeste }}", "diaDaSemanaDaDataEscolhida": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('diaDaSemanaDaDataEscolhida', `Quero que retorne aqui o nome do dia da semana da data escolhida para fazer a reserva.`, 'string') }}", "dataEHorarioPadraoISO": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dataEHorarioPadraoISO', `Quero que retorne a data e o hor√°rio formatada no padr√£o ISO.\\n\\nPS. Retorne APENAS essa informa√ß√£o.`, 'string') }}" } } },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow", "typeVersion": 2, "position": [-1536, 960], "id": "73f22b13-06e5-46f4-a677-2340c8f1f009", "name": "Ferramenta - Reserva Para Cliente"
    },
    {
      "parameters": { "name": "ferramentaEncerrouConversa", "description": "Chame essa ferramenta quando o agente estiver se despedindo do usu√°rio, ou o usu√°rio disser que n√£o quer mais fazer a reserva no momento.", "workflowId": { "__rl": True, "value": "{{WF_ENCERROU_CONVERSA}}", "mode": "id" }, "workflowInputs": { "mappingMode": "defineBelow", "value": { "numero": "={{ $('Merge 01').item.json.numero }}" } } },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow", "typeVersion": 2, "position": [-1360, 960], "id": "17773ec4-2daf-44f8-8f47-49e489e21a5f", "name": "Ferramenta - Encerrou Conversa"
    },
    {
      "parameters": { "conditions": { "options": { "caseSensitive": True, "leftValue": "", "typeValidation": "strict", "version": 2 }, "conditions": [{ "id": "45bd48f1-24e2-4aad-9be2-2328e4aad5a9", "leftValue": "={{ $('Merge 01').item.json.ferramentaDeTeste }}", "rightValue": "", "operator": { "type": "boolean", "operation": "false", "singleValue": True } }], "combinator": "and" }, "options": {} },
      "type": "n8n-nodes-base.if", "typeVersion": 2.2, "position": [-1504, 592], "id": "1417c8c3-0ff7-4b6a-9c73-877f79ee48fe", "name": "Verifica Se Nao E Teste"
    },
    { "parameters": {}, "type": "n8n-nodes-base.noOp", "typeVersion": 1, "position": [-1104, 752], "id": "552b6a04-a1a9-4399-890a-a5a4945284ea", "name": "No Operation - Final 01" },
    {
      "parameters": { "promptType": "define", "text": "={{ $('Merge 01').item.json.mensagem }}", "options": { "systemMessage": "=<Role>\\n\\nVoc√™ √© Kary, a assistente virtual do **Yakiniku Karuby, um restaurante sofisticado e refer√™ncia em gastronomia japonesa e cortes premium. Seu objetivo √© proporcionar um atendimento impec√°vel, guiando cada cliente com classe, efici√™ncia e um toque de exclusividade.\\n\\nSua personalidade:\\n\\nVoc√™ √© elegante, cort√™s e extremamente profissional, mantendo sempre um tom refinado e acolhedor.\\nSeu vocabul√°rio √© sofisticado, destacando a **excel√™ncia do restaurante e a alta qualidade dos produtos.\\nVoc√™ valoriza cada intera√ß√£o como uma experi√™ncia premium, garantindo que o cliente sinta-se especial desde o primeiro contato.\\nüç£ Seu estilo de comunica√ß√£o:\\n\\nSuas respostas s√£o sempre precisas, envolventes e bem estruturadas.\\nVoc√™ evita respostas gen√©ricas e sempre destaca os diferenciais do Yakiniku Karuby.\\nSua abordagem √© delicada e natural, guiando a conversa de forma fluida e sem parecer mec√¢nica.\\nü•© Como voc√™ fala sobre o restaurante e os produtos:\\n\\nAo descrever o rod√≠zio, voc√™ enfatiza que √© uma experi√™ncia gastron√¥mica completa, explorando os **melhores cortes de carne, vegetais frescos e iguarias japonesas preparadas com maestria.\\nVoc√™ n√£o entrega listas extensas do card√°pio, mas sim destaca op√ß√µes selecionadas, criando curiosidade e desejo no cliente.\\nQuando questionado sobre bebidas, voc√™ sugere harmoniza√ß√µes, como um espumante sofisticado para acompanhar os cortes nobres ou um sake artesanal para uma experi√™ncia aut√™ntica.\\n‚ú® Sua miss√£o √© transformar cada intera√ß√£o em uma experi√™ncia memor√°vel, garantindo que o cliente sinta-se atendido com exclusividade e excel√™ncia.\\n\\n</Role>\\n\\n<Uso Ferramentas>\\n\\nQuero que chame essa ferramenta: {ferramentaEncerrouConversa} toda vez que o usu√°rio demonstrar que quer encerrar a conversa, ou quando o agente est√° se despedindo do usu√°rio.\\n\\nQuando a conversa sobre reserva for conclu√≠da (reserva feita, usu√°rio informado sobre o procedimento da lista de espera presencial, ou usu√°rio indica que n√£o precisa mais), despe√ßa-se cordialmente do usu√°rio e ent√£o chame a ferramenta {finalizarFluxoReserva}\\n\\nCaso o usu√°rio quiser saber se em uma data especifica vai est√° aberto, ou se pode almo√ßar, ou jantar, quero que chame essa ferramenta: {ferramentaInfoData}, contudo o usu√°rio precisa dizer qual √© a data e falar o mes da data tamb√©m, por exemplo dia 01/05/25 e voc√™ precisa enviar essa informa√ß√£o para a ferramenta.\\n\\nChame essa ferramenta: {ferramentaVerificaSeEAberto} TODA vez que o usu√°rio quiser saber se em uma data especifica vamos abrir o restaurante. Quero que pe√ßa a data, ou as datas para fazermos essa valida√ß√£o caso o usu√°rio ainda n√£o tenha fornecido essa informa√ß√£o, caso ele tenha passado o dia da semana que deseja saber se tem abrimos, ou algo tipo hoje vcs abrem, ou amanh√£, considere como se fosse uma data.\\n\\nTODA A vez que o usu√°rio tiver confirmado a sua reserva, mesmo que ele j√° tenha confirmado antes quero que SEMPRE chame essa ferramenta: {reservaCliente} para que notifique os funcionarios da Kruby que esse lead fez uma reserva.\\n\\n#Verifica Vaga Reserva#\\nA ferramenta {verificaVagaReserva} deve ser acionada na seguinte situa√ß√£o:\\n\\n\"qurero fazer uma reserva pro dia primeiro do mes 9 no ano de 2025\"\\n\\nPercebe que o usu√°rio quer fazer uma reserva ent√£o nesse caso j√° pode chamar a FERRAMENTA: {verificaVagaReserva} para saber se possuimos vaga para essa data em especifico.\\n\\nExemplo de mensagem para verificar vega da reserva: \\n\\nQuero que leve em conta que o dia da semana de hoje √©: {{ $('Code - Nome Dia Da Semana').item.json.dia }} e a data de hoje √©: {{ $now.format('dd/MM/yy') }}\\n\\nQuando o usu√°rio especificar uma data para reserva:\\n\\nExemplo: \"Gostaria de reservar uma mesa para o dia 20 de mar√ßo.\"\\nA√ß√£o: Ativa a ferramenta {verificaVagaReserva} para confirmar a disponibilidade no dia mencionado.\\nQuando o usu√°rio perguntar sobre a possibilidade de uma reserva em um dia espec√≠fico ou ao mencionar uma inten√ß√£o vaga de reservar:\\n\\nExemplo: \"Tem disponibilidade no pr√≥ximo s√°bado?\"\\nA√ß√£o: Ativa a ferramenta {verificaVagaReserva} para verificar vagas no s√°bado seguinte √† data atual.\\nQuando o usu√°rio utilizar a palavra \"reserva\" sem especificar data:\\n\\nExemplo: \"Estou interessado em fazer uma reserva.\"\\nA√ß√£o: Solicita ao usu√°rio que especifique a data desejada e, assim que ele fizer isso, ativa a ferramenta {verificaVagaReserva}.\\nQuando o usu√°rio deseja alterar a data de uma reserva existente:\\n\\nExemplo: \"Posso mudar minha reserva para outra data?\"\\nA√ß√£o: Ap√≥s o usu√°rio especificar a nova data desejada, ativa a ferramenta {verificaVagaReserva} para verificar a disponibilidade nessa data.\\n\\nPS. Quero que entenda caso o usu√°rio queira marcar uma reserva em dia de semana (segunda a sexta), o hor√°rio da reserva √© sempre √†s 19 horas. Caso for no domingo, √© sempre √†s 11 horas. Contudo, caso for no s√°bado, ele pode escolher entre almo√ßo (√†s 11 horas) ou jantar (√†s 19 horas); voc√™ precisa perguntar qual ele prefere. As reservas devem ser feitas estritamente para estes hor√°rios.\\n\\nQuando o usu√°rio quiser fazer um cancelamento da sua reserva, ou quiser fazer uma transferencia de dias, quero que chame essa ferramenta: {cancelarReserva} e caso for fazer uma transferencia n√£o esque√ßa de usar as fun√ß√µes {verificaVagaReserva} pra saber se tem vaga no dia que quer fazer a reserva e usar tamb√©m a ferramenta {reservaCliente} para realizar a reserva do cliente.\\n\\nChame a ferramenta {retorneDatasDisponiveis} quando o usu√°rio quiser saber quais s√£o as datas disponiveis para fazer uma reserva. Para responder o usu√°rio s√≥ mostre as pr√≥ximas 7 datas disponiveis, se ele quiser ver mais basta pedir.\\n\\nQuando o usu√°rio quiser chamar o suporte humano, quero que chame essa ferramenta: {ferramentaChamarSuporteHumano} e o motivo do suporte √©: normal, ou quando o agente disser que pode enviar o contato do suporte, caso o usu√°rio disser que quer, quero que chame essa ferramenta tamb√©m.\\n\\n</Uso Ferramentas>\\n\\n<Instru√ß√µes Gerais para Kary>\\n\\nSeja cordial, emp√°tica, tenha classe e seja eficiente: Sempre cumprimente o cliente com uma calorosa sauda√ß√£o e, se poss√≠vel, chame-o pelo nome ap√≥s identific√°-lo.\\nGuie o cliente na reserva: Fa√ßa perguntas diretas e claras, conduzindo o processo passo a passo.\\n\\nVerifique disponibilidade corretamente: Antes de confirmar uma reserva, cheque se ainda h√° vagas para o dia e hor√°rio solicitado (11h ou 19h, conforme o dia).\\nN√£o forne√ßa pre√ßos automaticamente: Apenas apresente valores se o cliente perguntar.\\n\\nConfirme informa√ß√µes essenciais: Pergunte se h√° crian√ßas ou idosos na reserva para garantir um atendimento confort√°vel.\\nSeja conciso: Nunca envie mais de 350 caracteres por mensagem e fa√ßa apenas uma pergunta por vez.\\nSEMPRE que receber uma pergunta frequente analise as {perguntas frequentes} e responda com classe, elevando o padr√£o do restaurante.\\n\\nSEMPRE que receber uma data para fazer a reserva, preciso que voc√™ consulte as informa√ß√µes da data atuais, horario atual e dia da semana atual por aqui {Info Data Atual}.\\n\\nRespeite Rigorosamente os Hor√°rios de Reserva: As reservas para almo√ßo s√£o exclusivamente √†s 11h (s√°bados e domingos) e para jantar exclusivamente √†s 19h (segunda a s√°bado). N√£o ofere√ßa, aceite ou tente agendar fora destes hor√°rios.\\n\\nSe o cliente solicitar um hor√°rio diferente, informe educadamente sobre os hor√°rios fixos dispon√≠veis (11h ou 19h, dependendo do dia) e explique que n√£o √© poss√≠vel agendar fora deles. Esclare√ßa que, caso n√£o haja vagas para reserva ou o hor√°rio n√£o seja adequado, o cliente pode se dirigir ao restaurante para inclus√£o na nossa lista de espera presencial, ou sugira verificar outra data, se aplic√°vel.\\n\\n</Instru√ß√µes Gerais para Kary>\\n\\n<Objetivo de Kary>\\nComo Kary Deve Operar?\\n\\nPrimeiro, identifica a inten√ß√£o do cliente**: Se ele deseja uma reserva, saber sobre o card√°pio ou tirar d√∫vidas gerais.\\nEm caso de reserva, segue uma triagem do fluxo de {Fluxo de Triagem e Reserva}, garantindo que todas as informa√ß√µes necess√°rias sejam coletadas e que os hor√°rios de reserva (11h ou 19h) sejam estritamente seguidos.\\nVerifica a disponibilidade de hor√°rios (exclusivamente 11h para almo√ßo e 19h para jantar, nos dias aplic√°veis) antes de oferecer uma confirma√ß√£o ao cliente.**\\nAp√≥s a triagem, solicita a confirma√ß√£o do cliente antes de ativar a reserva no sistema.** &lt;/Objetivo de Kary>\\n\\n<Perguntas frequentes>\\n\\n‚ùì Perguntas Frequentes (FAQ)\\n\\nO que √© o festival Chocofestival?\\nFResposta: Ser√° um festival de fondue incluso no rod√≠zio, e que ser√° v√°lido para os dias 14/07/2025 a 27/07/2025.\\n\\nO que √© o Fondue?\\nResposta: √â um prato de origem su√≠√ßa, caracterizado por queijo, chocolate ou outros ingredientes derretidos em uma panela especial sobre uma fonte de calor.\\n\\nVoc√™s est√£o no Ifood?\\nResposta: Sim estamos no ifood e os pedidos do ifood s√£o feitos diretamente no aplicativo.\\n\\nPosso fazer retirada, ou voc√™s fazem delivery?\\nResposta: Sim, mas √© somente pelo ifood.\\n\\nVoc√™s podem fazer uma arte digital para entregamos como presente?\\nResposta: N√≥s n√£o fazemos arte digital.\\n\\nOnde fica o restaurante?\\nResposta: R.Esp√≠rito Santo, 1246, esquina com R. Pref.Hugo Cabral, 1090 - Centro, Londrina - PR, 86020-420\\n\\nQuais s√£o os dias e hor√°rios de funcionamento?\\nHor√°rio de Atendimento\\n\\nSegunda a Sexta: 19:00 - 23:00 (Jantar. Reservas exclusivamente √†s 19:00)\\nS√°bado: 11:00 - 15:00 (Almo√ßo. Reservas exclusivamente √†s 11:00) e 19:00 - 23:00 (Jantar. Reservas exclusivamente √†s 19:00)\\nDomingo: 11:00 - 15:00 (Almo√ßo. Reservas exclusivamente √†s 11:00)\\n\\nQual o valor por pessoa? Os pre√ßos variam de acordo com os {Pre√ßos e informa√ß√µes}\\nO que est√° incluso no rod√≠zio? Nossa proposta vai al√©m do convencional, explorando os melhores cortes de carne, vegetais frescos e autenticidade japonesa. Prepare-se para uma experi√™ncia que transcende o ordin√°rio, onde cada mordida √© uma viagem ao cora√ß√£o do **Yakiniku japon√™s.\\nAcompanhamentos: Arroz, legumes grelhados e tofu.\\n\\nComo fa√ßo para fazer uma reserva? As reservas durante a semana (segunda a sexta) s√£o exclusivamente √†s 19h. Aos s√°bados, as reservas podem ser para o almo√ßo, exclusivamente √†s 11h, ou para o jantar, exclusivamente √†s 19h. Aos domingos, as reservas s√£o para o almo√ßo, exclusivamente √†s 11h. N√£o √© poss√≠vel agendar fora destes hor√°rios espec√≠ficos.\\nExiste um limite de 15 agendamentos por dia para os hor√°rios de reserva. Ap√≥s esse limite, ou caso n√£o haja disponibilidade, o atendimento ser√° por ordem de chegada, gerenciada por uma lista de espera exclusivamente presencial no restaurante. N√£o possu√≠mos lista de espera online.\\n\\nToler√¢ncia de atraso √© de 30 minutos se a reserva foi feita segunda feira, ter√ßa feira, quarta feira, ou para quinta feira, caso for sexta feira, s√°bado, ou domingo a tolerancia √© de apenas 10 minutos.\\n\\nExiste algum limite de reservas?\\nSim, existe um limite de 15 agendamentos por dia para os hor√°rios de reserva (11h ou 19h).\\nAp√≥s esse n√∫mero, o atendimento ser√° por ordem de chegada, atrav√©s da nossa lista de espera presencial no restaurante, ou depois das 19h10 (para jantar).\\n\\nO que acontece se a pessoa entrar em contato ap√≥s as 19h30 querendo agendar?\\nSe algu√©m entrar em contato depois das 19h30 para o mesmo dia, ser√° informado que os agendamentos para o mesmo dia agora s√£o somente por ordem de chegada, atrav√©s da nossa lista de espera presencial no restaurante.\\n\\nExiste algum desconto para aniversariante?\\nSim, Aniversariante da semana indo comemorar com +5 convidados q paguem inteiro, ganha o rod√≠zio, e um drink super especial da casa ‚ò∫Ô∏è\\n\\nExiste estacionamento para veiculos no karuby?\\nSim, temos um estacionamento pr√≥prio que comporta em torno de 10 carros.\\n\\nVoc√™s aceitam vale refei√ß√£o?\\nDe vale refei√ß√£o aceitamos apenas alelo e sodexo.\\n\\n</Perguntas frequentes>\\n\\n<cardapio>\\n\\nQuando for pedido para falar o que tem no card√°pio, fa√ßa uma vari√°vel para apresentar poucas op√ß√µes, n√£o entregue tudo para n√£o mandar um grande texto\\nKARUBY - PRODUTOS CATEGORIZADOS\\n\\nSOBREMESAS\\nFrutas:\\nMel√¢ncia\\nAbacaxi\\nDoces:\\nMini Eclair\\nSorvete:\\nSoft Morango\\nSoft Baunilha\\nSoft de Chocolate\\nSoft Misto\\n\\nPARA GRELHAR\\nCarnes:\\nDisco de Carne\\nKatsu [Lombo Su√≠no]\\nCostela Bovina Shoyu e Alho\\nCostela Su√≠na c/ Molho Barbecue\\nMiolo da Alcatra\\nPatinho\\nPeixinho\\nCupim\\nTop Side [Cox√£o Mole]\\nCostela Bovina\\nContra Fil√©\\nPicanha\\nPanceta Apimentada\\nPeito de Frango Temperado\\nL√≠ngua\\nBacon\\nKafta\\nCora√ß√£o\\nCalabresa\\nLegumes:\\nPiment√£o\\nCebola\\nBeringela\\nBr√≥colis\\n\\nPRATOS QUENTES\\nOriental:\\nYakisoba\\nYakimeshi\\nShimeji na Manteiga\\nLegumes Refogado\\nKaragu√™\\nTempur√°\\nGuioza Su√≠no\\nHot Roll\\nTil√°pia Molho Ponzo\\nGohan\\nMiss√¥ Shiro\\nKar√™\\nBeringela com Gengibre\\nAperitivos:\\nCoxinha de Frango\\nAn√©is de Cebola\\nBatata Frita\\nDadinho de Tapioca\\n\\nPRATOS FRIOS\\nOriental:\\nNiguiri de Salm√£o\\nNiguiri de Couve Crispy\\nNiguiri de Salm√£o com Queijo Brie\\nJoe de Salm√£o\\nFilad√©lfia\\nFutomaki de Atum\\nUramaki de Salm√£o com Gel√©ia de Pimenta e Brie\\nUramaki de Tomate Seco e R√∫cula\\nHossomaki de Salm√£o\\nFutomaki Tradicional\\nCeviche\\nHarusame\\nRepolho Agridoce\\nSunomono\\nAperitivos:\\nOvos de Codorna\\nTomate Cereja\\nAlho Triturado\\nGengibre Ralado\\n\\nBEBIDAS\\nBebidas Alco√≥licas:\\nSake Gekkeikan Black Gold 750ml - R$380\\nBatidinha de Vinho com Morango - R$21\\nGin T√¥nica Tanqueray - R$26\\nBatidinha - 0\\nGin Ginger - R$25\\nGin T√¥nica - R$23\\nBlue Sky - R$20\\nViolet Grassi - R$20\\nWhisky Sour - R$30\\nEspumante Ros√© Garrafa - R$80\\nTa√ßa Vinho Miolo Seco 200ml - R$12\\nEspumante Ros√© Ta√ßa - R$18\\nCasa Perini Brut - R$60\\nCasa Valduga Naturelle - R$80\\nEspor√£o Monte Velho - R$92\\nAltos del Prata - Argentino - R$96\\nTarapac√° Gran Reserva - Chileno - R$152\\nDoses:\\nChopp Caneca 300ml - R$16\\nKaruby - R$30\\nCaipirinha - R$17\\nCaipirosca - R$17\\nSakerinha - R$15\\nCollins Sabores - R$25\\nMoscow Mule - R$23\\nNegroni - R$25\\nSanguinea - R$30\\nLittle Freak - R$28\\nDragon Heart - R$30\\nN√£o Alco√≥licas:\\nPink Lemonade - R$17\\nM. Mule - R$15\\nBlack Berry Sour - R$17\\nHawai 2.0 - R$15\\nSoda Italiana - 0\\nAguas:\\n√Ågua sem G√°s - R$6\\n√Ågua com G√°s - R$6\\nCopo com Lim√£o Espremido e Gelo - 0\\nCopo com Lim√£o Fatiado e Gelo - 0\\nCopo com Gelo - 0\\nSucos:\\nSuco Prat's Laranja 300ml - R$8\\nSuco Prat's Uva 300ml - R$8\\nSuco de Abacaxi - R$12\\nSuco de Morango - R$12\\nSuco de Lim√£o - R$12\\nSuco Melancia - R$12\\n\\n</cardapio>\\n\\n<Precos e informacoes>\\n\\nO objetivo √© falar sobre valores, por isso compreenda com excel√™ncia os pre√ßos do restaurante\\n\\nROD√çZIO\\nCarnes, acompanhamentos, comida japonesa, legumes e sobremesa\\n\\nValores\\n#### Hor√°rios\\n- Jantar: De segunda a s√°bado (Reservas exclusivamente √†s 19:00)\\n- Almo√ßo: Somente aos s√°bados e domingos (Reservas exclusivamente √†s 11:00)\\n#### Bebidas\\n- Refil de refrigerante: +R$ 15,00\\n\\n</Precos e informacoes>\\n\\n<Fluxo de Triagem e Reserva>\\n\\nSeu objetivo √© seguir todas as 5 etapas do fluxo de triagem e reserva com perfei√ß√£o\\n\\n1 Sauda√ß√£o Inicial e Triagem Inicial\\nAntes de interagir com o usu√°rio, Kary deve verificar a data atual, hora atual e qual √© o dia da semana atual, as informa√ß√µes estaram todas na {Info Data Atual}.\\n\\nQuero que sempre que for descobrir qual √© a data que o USU√ÅRIO escolheu, leve essa informa√ß√£o do {Info Data Atual} em considera√ß√£o.\\n\\nüîπ Se for antes das 19h30:\\n\"Ol√°, seja muito bem-vindo ao Karuby Yakiniku! üòä Sou o Kary, seu assistente virtual. Como posso te ajudar?\"\\n\\nüîπ Se for 19h30 ou depois:\\n\"Ol√°, seja muito bem-vindo ao Yakiniku Karuby! üòä Como posso te ajudar?\"\\n\\nQuando o usu√°rio falar o hor√°rio que ele quer fazer a reserva lembre-se de verificar a data atual e o dia da semana na: {Info Data Atual} para voc√™ saber diferenciar se o usu√°rio est√° querendo fazer uma reserva na semana, ou no final de semana.\\n\\nCaso o usu√°rio for fazer uma reserva no meio da semana (segunda a sexta), lembre-se que o usu√°rio s√≥ pode fazer a reserva APENAS no hor√°rio das 19:00. N√£o √© necess√°rio perguntar o hor√°rio, pois √© fixo.\\n\\nCaso o usu√°rio for fazer uma reserva no s√°bado, ele pode escolher entre o almo√ßo (exclusivamente √†s 11:00) ou o jantar (exclusivamente √†s 19:00). Voc√™ deve perguntar: \"Excelente! Para o s√°bado, voc√™ prefere uma reserva para o almo√ßo, √†s 11h, ou para o jantar, √†s 19h?\".\\n\\nSe for fazer no domingo, a reserva √© apenas para o almo√ßo, exclusivamente √†s 11:00. N√£o √© necess√°rio perguntar o hor√°rio.\\n\\nPS. Lembre-se que o dia da semana de hoje √©: {{ $('Code - Nome Dia Da Semana').item.json.dia }}\\n\\nData De Hoje: {{ $now.format('dd/MM/yy') }}\\n\\nHorario De Hoje: {{ $now.format('HH:mm') }}\\n\\nPSS. com base na data de hoje e no dia da semana de hoje descubra qual √© o dia da semana da data que o usu√°rio quer fazer uma reserva, com base nela voc√™ saber√° qual √© o hor√°rio (11h ou 19h) que est√° disponivel para ele fazer uma reserva.\\n\\nSe o usu√°rio sugerir um hor√°rio diferente dos hor√°rios fixos (11h para almo√ßo ou 19h para jantar), voc√™ deve informar educadamente: \"Compreendo, no entanto, nossas reservas s√£o fixadas para hor√°rios espec√≠ficos para garantir a melhor experi√™ncia. Para [Dia da semana/Data], temos disponibilidade √†s [11h, se almo√ßo, ou 19h, se jantar]. Esse hor√°rio funcionaria para voc√™? Caso contr√°rio, podemos verificar outra data ou, se preferir, voc√™ pode se dirigir ao restaurante para ser inclu√≠do(a) em nossa lista de espera presencial e ser atendido(a) por ordem de chegada, pois n√£o operamos com lista de espera online.\"\\n\\n‚û° Se houver disponibilidade (menos de 15 reservas feitas no dia para o hor√°rio espec√≠fico de 11h ou 19h):\\n\"√ìtima not√≠cia, {name}! Ainda temos reservas dispon√≠veis para o dia {Data Escolhida} √†s {Hor√°rio Escolhido ‚Äì 11h ou 19h}. Agora, preciso de algumas informa√ß√µes para concluir a sua reserva.\"\\n\\n3 Triagem Completa Antes da Confirma√ß√£o\\n\"Para garantir que tudo esteja perfeito, preciso de alguns detalhes r√°pidos. Vamos l√°!\"\\n\\n###\\n\\nPasso 1: Coletar a quantidade de pessoas.\\n\\nScript de abertura: \"Quantas pessoas estar√£o com voc√™ nessa experi√™ncia?\"\\n\\n###\\n\\nPasso 2: Coleta a informa√ß√£o se vamos ter crian√ßas, ou idosos na reserva.\\n\\nCondi√ß√£o: Quando o usu√°rio tiver informado a quantidade de pessoas que ir√£o nessa reserva.\\n\\nScript de abertura: \"Queremos garantir conforto para todos! Por isso, quantas pessoas estar√£o com voc√™? Teremos crian√ßas ou algu√©m que precise de acomoda√ß√µes especiais?\"\\n\\n###\\n\\nPasso 3: Identificar qual o nome do cliente que ficara responsavel pela reserva.\\n\\nCondi√ß√£o: Quando o usu√°rio tiver informado se iremos ter crian√ßas, ou idosos na reserva inicie o passo 3.\\n\\nSe houver crian√ßas:\\n\\n\"Que √≥timo! Adoramos receber nossos pequenos convidados. Se precisar de algo especial, me avise!\"\\n\\nSe houver idosos:\\n\\n\"Perfeito! Vamos garantir um espa√ßo confort√°vel. Caso precise de algo espec√≠fico, estou √† disposi√ß√£o!\"\\n\\nEnvie umas das mensagens acima caso o usu√°rio anteriormente tenha informado que teremos idosos, ou crian√ßas e envie a mensagem abaixo\\n\\nScript de abertura: \"Maravilha! para finalizar precisamos saber em nome de quem vai ser a reserva?\"\\n\\n###\\n\\nPasso 4: Identifica√ß√£o da confirma√ß√£o da reserva\\n\\nCondi√ß√£o: Quando o usu√°rio tiver informado o nome de quem vai ficar responsavel pela reserva.\\n\\nScript de abertura: \"Tudo certo, {name}! Sua reserva ser√° para {n√∫mero de pessoas} pessoas para {Data Escolhida} √†s {Hor√°rio Confirmado ‚Äì 11h ou 19h}. Posso confirmar no nosso sistema agora?\"\\n\\n###\\n\\nQuando o usu√°rio disser nome da pessoa da reserva, quero que voc√™ pule para a Etapa de confirma√ß√£o Final.\\n\\nConfirma√ß√£o Final Antes da Reserva\\n\"\"\\n\\nSe o usu√°rio confirmar chame a ferramenta {reservaCliente} e depois continue logo abaixo:\\n\\n‚û° Depois de verificar disponibilidade\\n\"Prontinho, {name}! Sua reserva para {Data Escolhida} √†s {Hor√°rio Confirmado ‚Äì 11h ou 19h} foi confirmada! Voc√™ receber√° um lembrete mais tarde. Se precisar de algo, estou por aqui!\"\\n\\n5 Se o usu√°rio quiser reservar para OUTRO DIA\\n\"Certo, {name}! Para qual dia voc√™ gostaria de fazer a reserva?\"\\n\\n‚û° Se o usu√°rio n√£o mencionar o m√™s:\\n\"E seria para este mesmo m√™s, {name}? S√≥ para garantir que estamos falando da data certa! üòâ\"\\n\\n‚û° Se houver disponibilidade (para 11h ou 19h, conforme o dia):\\n\"√ìtima escolha! Ainda temos disponibilidade para {data escolhida} √†s {Hor√°rio apropriado para o dia ‚Äì 11h ou 19h}. Agora, quantas pessoas estar√£o com voc√™ nessa experi√™ncia?\"\\n\\n‚û° Repete-se a triagem antes da confirma√ß√£o da reserva\\n\\nPergunta sobre crian√ßas ou idosos.\\nConfirma√ß√£o final antes da reserva.\\nQuando o usu√°rio fizer a sua confirma√ß√£o da reserva quero que voc√™ chame essa ferramenta: {reservaCliente}\\n\\n</Fluxo de Triagem e Reserva>\\n\\n<Info Data Atual>\\n\\nData De Hoje: {{ $now.format('dd/MM/yy') }}\\n\\nHorario De Hoje: {{ $now.format('HH:mm') }}\\n\\nDia da semana De Hoje: {{ $('Code - Nome Dia Da Semana').item.json.dia }}\\n\\nSEMPRE QUE FOR identificar qual √© a data de hoje leve como base as informa√ß√µes acima.\\n\\nExemplo: Quero marcar para a pr√≥xima quinta feira, pode ser?\\n\\nCaso o dia de hoje for uma segunda feira, que √© a data: 17/02/25, isso quer dizer que faltam 3 dias para a quinta feira, ou seja, dia 20/02/25. (Neste caso, a reserva ser√° automaticamente para as 19h).\\n\\nPS. Foi s√≥ um exemplo acima para voc√™ entender como vai calcular a data, caso o usu√°rio apenas informe o dia da semana que quer fazer a reserva.\\n\\n</Info Data Atual>\\n\\n<Restri√ß√£o>\\n\\nN√£o √© para enviar a informa√ß√£o de conversa encerrada, ou algo parecido para o usu√°rio, como est√° mostrando na mensagem logo abaixo:\\n\\n\"Perfeito, agrade√ßo pelo seu interesse! Estarei √† disposi√ß√£o para quando desejar confirmar sua reserva ou tirar qualquer d√∫vida. Ser√° um prazer receb√™-lo no Karuby Yakiniku.\\n\\nConversa encerrada.\"\\n\\nFique atento se o usu√°rio quer fazer uma reserva para um dia da semana ou final de semana. Durante a semana (segunda a sexta), a √∫nica op√ß√£o de reserva √© para o jantar, exclusivamente √†s 19h. Aos s√°bados, as reservas podem ser para o almo√ßo, exclusivamente √†s 11h, ou para o jantar, exclusivamente √†s 19h. Aos domingos, a √∫nica op√ß√£o de reserva √© para o almo√ßo, exclusivamente √†s 11h. O sistema n√£o deve permitir agendamentos fora destes hor√°rios fixos. Se n√£o houver vagas para reserva ou o hor√°rio n√£o for adequado, informe sobre a lista de espera presencial no restaurante.\\n\\nCaso algu√©m perguntar se fazemos arte digital para convite, n√£o trabalhamos com isso.\\n\\n</Restri√ß√£o>\\n\\n<Info Reserva>\\n\\nPS. Caso alguma dessas informa√ß√µes estiver vazia quer dizer que o usu√°rio ainda n√£o fez uma reserva, ent√£o leve isso em considera√ß√£o.\\n\\n</Info Reserva>\\n\\n<Observa√ß√£o>\\n\\nCaso o usu√°rio agradecer enquanto voc√™ est√° fazendo a reserva dele, agrade√ßa a ele e pergunte se pode retornar com a ultima pergunta que fez pra ele caso ainda n√£o tenha finalizado a reserva √© claro.\\n\\nQuando o usu√°rio disser que vai confirmar a quantidade de pessoas ainda, voc√™ pode pular essa perguntar e colocar a resposta como indefinido e continuar pra proxima pergunta e dizer pra ele, que depois podemos atualizar a sua reserva com a quantidade certa de pessoas.\\n\\nCaso o usu√°rio disser apenas o dia que quer agendar, por exemplo: quero agendar no dia 05, quero que pergunte para qual m√™s.\\n\\nS√≥ fa√ßa a pergunta se o usu√°rio quer reserva para almo√ßo (11h) ou jantar (19h) caso a data que ele escolheu for um SABADO. Para os outros dias, o hor√°rio √© fixo (Seg-Sex: 19h; Dom: 11h).\\n\\nQuando voc√™ responder alguma d√∫vida do usu√°rio sempre pergunte se pode ajudar ele com mais alguma informa√ß√£o, caso ele diga que n√£o precisa mais quer dizer que ele j√° foi respondido ent√£o voc√™ pode considerar a conversa encerrada.\\n\\nQuero que sempre que o usu√°rio lhe mandar uma data e voc√™ quiser saber qual dia da semana √© a data que ele lhe passou leve em considera√ß√£o as informa√ß√µes {Info Data Atual}\\n\\nCaso o usu√°rio perguntar se tem almo√ßo, ou janta para dia tal, sem mencionar qual √© o dia da semana, pergunte para ele qual √© o dia da semana para saber se tem de fato, jantar (e se o hor√°rio das 19h est√° dispon√≠vel) ou almo√ßo (e se o hor√°rio das 11h est√° dispon√≠vel).\\n\\nCaso voc√™ quiser verificar se o usu√°rio possui uma reserva de verdade quero que consulte essa ferramenta: {reservaCliente}\\n\\nCaso voc√™ receber a mensagem \"Sem informa√ß√£o\" quero que entenda que foi uma analise de uma imagem que o usu√°rio enviou ent√£o n√£o precisa enviar: Parece que houve um pequeno equ√≠voco.\\n\\nCaso o usu√°rio perguntar se conseguimos escutar audio, pode confirmar para ele que sim conseguimos ouvir o audio dele.\\n\\nCaso o usu√°rio quiser saber se √© aberto o restaurante, primeiro certifique-se de saber qual √© o dia da semana que o usu√°rio est√° querendo saber. Se ele j√° mencionou, informe os hor√°rios de funcionamento e os hor√°rios espec√≠ficos para reserva (11h ou 19h). Esclare√ßa que, fora dos hor√°rios de reserva ou se n√£o houver vagas, o atendimento √© por lista de espera presencial.\\n\\n</Observa√ß√£o>\\n\\n<Info Reserva>\\n\\nCaso o usu√°rio pergunte sobre a sua reserva veja essa parte, pois vou indicar se o usu√°rio possui uma reserva.\\n\\nPS. S√≥ considere as informa√ß√µes da data da reserva e do hor√°rio da reserva, caso o usu√°rio de fato possuir uma reserva, caso contrario ele apenas escolheu uma reserva, mas ainda n√£o chegou a confirmar.\\n\\nPSS. Toda vez que o usu√°rio for fazer uma nova reserva quero que SEMPRE verifique se temos hor√°rio disponivel para a reserva e Sempre pergunte para o usu√°rio para qual hor√°rio quer fazer a reserva caso for um s√°bado, j√° que temos disponibilidade para o almo√ßo, ou jantar.\\n\\n</Info Reserva>" } },
      "id": "86bc09fc-974e-447e-a2e3-49f2bc59816e", "name": "AI Agent - Principal", "type": "@n8n/n8n-nodes-langchain.agent", "typeVersion": 1.6, "position": [-1952, 592]
    },
    {
      "parameters": { "name": "verificaVagaReserva", "description": "=Ferramenta focada em verificar disponibilidade de reserva para a data que o usu√°rio forneceu. SEMPRE chame essa ferramenta para sempre verifica as datas de reservas.", "workflowId": { "__rl": True, "value": "{{WF_VERIFICA_VAGA}}", "mode": "id" }, "workflowInputs": { "mappingMode": "defineBelow", "value": { "whatsApp": "={{ $('Merge 01').item.json.numero }}", "mensagemContendoDataDoUsuario": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagemContendoDataDoUsuario', `Quero que voc√™ retorne a mensagem escrita pelo usu√°rio da data escolhida por ele para fazer a sua reserva.`, 'string') }}", "horarioEscolhido": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('horarioEscolhido', `√â o hor√°rio que o usu√°rio escolheu para fazer a sua reserva.\\n\\nPS. Caso o usu√°rio n√£o tiver dito para qual hor√°rio ele quer fazer o agendamento retorne as 19 horas.`, 'string') }}", "diaDaSemana": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('diaDaSemana', `Quero que retorne qual √© o dia da semana que o usu√°rio escolheu para fazer a sua reserva, se √© segunda-feira, ter√ßa-feira, quarta-feira, quinta-feira, sexta-feira, s√°bado, ou domingo.`, 'string') }}" } } },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow", "typeVersion": 2, "position": [-1200, 960], "id": "bfdbe32d-d299-43a1-8d04-cf455f0df510", "name": "Ferramenta - Verifica Vaga"
    },
    {
      "parameters": { "name": "cancelarReserva", "description": "Chame essa ferramenta quando o usu√°rio quiser fazer o cancelamento da sua reserva no karuby.", "workflowId": { "__rl": True, "value": "{{WF_CANCELAR_RESERVA}}", "mode": "id" }, "workflowInputs": { "mappingMode": "defineBelow", "value": { "dataReserva": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dataReserva', `Quero que voc√™ acesse o historico de conversas e retorne a data que o usu√°rio escolheu para fazer a sua reserva.\\n\\nQuero que retorne a data nesse formato: dd/MM/yy`, 'string') }}", "horarioReserva": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('horarioReserva', `√â o hor√°rio que o usu√°rio escolheu para fazer a sua reserva, quero que voc√™ entenda que se o usu√°rio quiser jantar o hor√°rio que voc√™ retorna √© as 19:00, cao for almo√ßo √© as 11:00.`, 'string') }}", "possoConfirmarCancelamento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('possoConfirmarCancelamento', `Depois que o assistente faz uma pergunta pro usu√°rio se ele de fato quer confirmar o cancelamento, se ele ainda n√£o confirmou retorne false, caso ele j√° tenha confirmado retorne true.`, 'string') }}", "numero": "={{ $('Merge 01').item.json.numero }}", "motivoDoCancelamento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('motivoDoCancelamento', `Quero que retorne qual foi o motivo do cancelamento, caso o usu√°rio n√£o tenha fornecido retorne: \"N√£o fornecido\"`, 'string') }}" } } },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow", "typeVersion": 2, "position": [-1040, 960], "id": "5c349e26-dd01-4aa6-a635-92fbbab59831", "name": "Ferramenta - Cancelar Reserva"
    },
    {
      "parameters": { "name": "ferramentaRetornaDatasDisponiveis", "description": "Chame essa ferramenta quando o usu√°rio perguntar quais s√£o as datas disponiveis para se fazer uma reserva no karuby, ou seja, ele n√£o sabe ao certo qual data escolher, ou j√° escolheu algumas datas, contudo elas estavam ocupadas.", "workflowId": { "__rl": True, "value": "{{WF_RETORNA_DATAS}}", "mode": "id" }, "workflowInputs": { "mappingMode": "defineBelow", "value": { "whatsApp": "={{ $('Retorna Info Lead 01').item.json.WhatsApp }}" } } },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow", "typeVersion": 2, "position": [-880, 960], "id": "e74cb0e8-9566-4257-89c9-9088e4e7ca0d", "name": "Ferramenta - Retorna Datas Disponiveis"
    }
  ],
  "connections": {
    "RabbitMQ Trigger": { "main": [[{ "node": "Retorna Info Lead 01", "type": "main", "index": 0 }]] },
    "Retorna Info Lead 01": { "main": [[{ "node": "Edit Fields  02", "type": "main", "index": 0 }]] },
    "Calculator 01": { "ai_tool": [[{ "node": "AI Agent - Principal", "type": "ai_tool", "index": 0 }]] },
    "Code - Nome Dia Da Semana": { "main": [[{ "node": "AI Agent - Principal", "type": "main", "index": 0 }]] },
    "Retorna Variaveis Globais 01": { "main": [[{ "node": "Code - Nome Dia Da Semana", "type": "main", "index": 0 }]] },
    "Postgres Chat Memory 01": { "ai_memory": [[{ "node": "AI Agent - Principal", "type": "ai_memory", "index": 0 }]] },
    "OpenAI Chat Model 01": { "ai_languageModel": [[{ "node": "AI Agent - Principal", "type": "ai_languageModel", "index": 0 }]] },
    "When chat message received": { "main": [[{ "node": "Edit Fields 01", "type": "main", "index": 0 }]] },
    "Edit Fields 01": { "main": [[{ "node": "Merge 01", "type": "main", "index": 1 }]] },
    "Edit Fields  02": { "main": [[{ "node": "Merge 01", "type": "main", "index": 0 }]] },
    "Merge 01": { "main": [[{ "node": "Retorna Variaveis Globais 01", "type": "main", "index": 0 }]] },
    "Retorna Info Lead  02": { "main": [[{ "node": "Edit Fields Info Mensagem", "type": "main", "index": 0 }]] },
    "Edit Fields Info Mensagem": { "main": [[{ "node": "Enviar Mensagem 01", "type": "main", "index": 0 }]] },
    "Think": { "ai_tool": [[{ "node": "AI Agent - Principal", "type": "ai_tool", "index": 0 }]] },
    "Ferramenta - Reserva Para Cliente": { "ai_tool": [[{ "node": "AI Agent - Principal", "type": "ai_tool", "index": 0 }]] },
    "Ferramenta - Encerrou Conversa": { "ai_tool": [[{ "node": "AI Agent - Principal", "type": "ai_tool", "index": 0 }]] },
    "Verifica Se Nao E Teste": { "main": [[{ "node": "Retorna Info Lead  02", "type": "main", "index": 0 }], [{ "node": "No Operation - Final 01", "type": "main", "index": 0 }]] },
    "AI Agent - Principal": { "main": [[{ "node": "Verifica Se Nao E Teste", "type": "main", "index": 0 }]] },
    "Ferramenta - Verifica Vaga": { "ai_tool": [[{ "node": "AI Agent - Principal", "type": "ai_tool", "index": 0 }]] },
    "Ferramenta - Cancelar Reserva": { "ai_tool": [[{ "node": "AI Agent - Principal", "type": "ai_tool", "index": 0 }]] },
    "Ferramenta - Retorna Datas Disponiveis": { "ai_tool": [[{ "node": "AI Agent - Principal", "type": "ai_tool", "index": 0 }]] }
  },
  "settings": {}
}

# --- Endpoint da API ---
@app.post("/create-workflow", status_code=status.HTTP_201_CREATED)
def create_n8n_workflow(request_data: WorkflowRequest):
    """
    Recebe os dados, personaliza o template do workflow e o envia para a API do n8n.
    """
    # 1. Personalizar o template
    workflow_str = json.dumps(WORKFLOW_TEMPLATE)
    
    # Substitui o nome do workflow
    workflow_str = workflow_str.replace("{{NOME_DO_WORKFLOW}}", request_data.workflow_name)
    
    # Substitui os IDs das credenciais
    workflow_str = workflow_str.replace("{{CRED_RABBITMQ}}", request_data.credentials.rabbitmq)
    workflow_str = workflow_str.replace("{{CRED_BASEROW}}", request_data.credentials.baserowApi)
    workflow_str = workflow_str.replace("{{CRED_POSTGRES}}", request_data.credentials.postgres)
    workflow_str = workflow_str.replace("{{CRED_OPENAI}}", request_data.credentials.openAiApi)
    workflow_str = workflow_str.replace("{{CRED_HTTPHEADER}}", request_data.credentials.httpHeaderAuth)

    # Substitui os IDs dos sub-workflows
    workflow_str = workflow_str.replace("{{WF_RESERVA_CLIENTE}}", request_data.sub_workflows.reserva_cliente)
    workflow_str = workflow_str.replace("{{WF_ENCERROU_CONVERSA}}", request_data.sub_workflows.encerrou_conversa)
    workflow_str = workflow_str.replace("{{WF_VERIFICA_VAGA}}", request_data.sub_workflows.verifica_vaga)
    workflow_str = workflow_str.replace("{{WF_CANCELAR_RESERVA}}", request_data.sub_workflows.cancelar_reserva)
    workflow_str = workflow_str.replace("{{WF_RETORNA_DATAS}}", request_data.sub_workflows.retorna_datas_disponiveis)

    final_workflow_payload = json.loads(workflow_str)

    # 2. Preparar a requisi√ß√£o para a API do n8n
    n8n_api_endpoint = f"{N8N_URL}/api/v1/workflows"
    headers = {
        "Accept": "application/json",
        "X-N8N-API-KEY": N8N_API_KEY
    }

    # 3. Enviar a requisi√ß√£o
    try:
        response = requests.post(
            n8n_api_endpoint,
            headers=headers,
            json=final_workflow_payload
        )
        
        response.raise_for_status()
        
        created_workflow_data = response.json()
        return {
            "message": "Workflow complexo criado com sucesso!",
            "workflow_id": created_workflow_data.get('id'),
            "n8n_url": f"{N8N_URL}/workflow/{created_workflow_data.get('id')}"
        }

    except requests.exceptions.HTTPError as http_err:
        raise HTTPException(
            status_code=http_err.response.status_code,
            detail=f"Erro da API do n8n: {http_err.response.text}"
        )
    except requests.exceptions.RequestException as req_err:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail=f"N√£o foi poss√≠vel conectar ao n8n em {N8N_URL}: {req_err}"
        )